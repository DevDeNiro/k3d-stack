# Network Policies for proper network segmentation
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: storage-network-policy
  namespace: storage
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow connections from same namespace (storage)
  - from:
    - namespaceSelector:
        matchLabels:
          name: storage
  # Allow connections from applications that need storage
  - from:
    - namespaceSelector:
        matchLabels:
          name: votchain-main
  - from:
    - namespaceSelector:
        matchLabels:
          name: security  # Keycloak needs PostgreSQL
  egress:
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow connections within storage namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: storage

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: messaging-network-policy
  namespace: messaging
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow connections from same namespace (messaging)
  - from:
    - namespaceSelector:
        matchLabels:
          name: messaging
  # Allow connections from applications that need messaging
  - from:
    - namespaceSelector:
        matchLabels:
          name: votchain-main
  egress:
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow connections within messaging namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: messaging

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: security-network-policy
  namespace: security
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow connections from same namespace (security)
  - from:
    - namespaceSelector:
        matchLabels:
          name: security
  # Allow connections from applications that need authentication
  - from:
    - namespaceSelector:
        matchLabels:
          name: votchain-main
  # Allow connections from ingress
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
  egress:
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow connections to storage (PostgreSQL)
  - to:
    - namespaceSelector:
        matchLabels:
          name: storage
    ports:
    - protocol: TCP
      port: 5432
  # Allow connections within security namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: security

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-network-policy
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow connections from same namespace (monitoring)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
  # Allow connections from ingress for dashboard access
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
  # Allow metrics scraping from all namespaces
  - from: []
    ports:
    - protocol: TCP
      port: 9090  # Prometheus
    - protocol: TCP
      port: 3000  # Grafana
    - protocol: TCP
      port: 9100  # Node exporter
  egress:  
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow scraping metrics from all namespaces
  - to: []
    ports:
    - protocol: TCP
      port: 8080  # Common metrics port
    - protocol: TCP
      port: 9100  # Node exporter
    - protocol: TCP
      port: 9187  # PostgreSQL exporter
    - protocol: TCP
      port: 9121  # Redis exporter

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vault-network-policy
  namespace: vault
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow connections from same namespace (vault)
  - from:
    - namespaceSelector:
        matchLabels:
          name: vault
  # Allow connections from applications that need secrets
  - from:
    - namespaceSelector:
        matchLabels:
          name: votchain-main
  egress:
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow connections within vault namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: vault
